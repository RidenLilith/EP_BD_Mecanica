<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Oficina – Painel</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<style>
  :root {
    --sidebar-bg: #6d28d9;   /* roxo */
    --sidebar-bg-dark: #5b21b6;
    --sidebar-text: #f8fafc;
    --content-bg: #0f172a;   /* azul quase preto */
    --card-bg: #111827;
    --card-border: #1f2937;
    --muted: #9ca3af;
    --text-purple: #c4b5fd;
  }
  html, body { height: 100%; background: var(--content-bg); color: var(--text-purple); }
  .layout { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }
  .sidebar {
    background: linear-gradient(180deg, var(--sidebar-bg), var(--sidebar-bg-dark));
    color: var(--sidebar-text);
    padding: 18px 12px;
  }
  .brand { font-weight: 700; letter-spacing: .5px; }
  .nav-link {
    color: var(--sidebar-text); opacity: .9; border-radius: 10px;
    display: flex; align-items: center; gap: .6rem; padding: .55rem .75rem;
  }
  .nav-link.active, .nav-link:hover { background: rgba(255,255,255,.14); color: #fff; }
  .content { padding: 24px; }
  .card { color: var(--text-purple); background: var(--card-bg); border: 1px solid var(--card-border); }
  .muted { color: var(--muted); }
  .table { --bs-table-bg: transparent; --bs-table-color: #e5e7eb; }
  .table thead th { color: var(--muted); font-weight: 600; }
  .section-title { display:flex; align-items:center; gap:.6rem; margin-bottom:.75rem; color: #ffffff; }
  .section-title i { color:#a78bfa }
  .form-label { color: #ffffff; }
  /* Headings - Branco */
  h1, h2, h3, h4, h5, h6 { color: #ffffff !important; }
  /* Inputs, Selects, Textareas - Texto Branco */
  .form-control, .form-select { color: #ffffff !important; background-color: #1f2937; border-color: #374151; }
  .form-control::placeholder { color: #9ca3af; }
  .form-control:focus, .form-select:focus { color: #ffffff; background-color: #1f2937; border-color: #6d28d9; box-shadow: 0 0 0 0.2rem rgba(109, 40, 217, 0.25); }
  .form-control::-webkit-input-placeholder { color: #9ca3af; }
  .form-select option { color: #ffffff; background-color: #1f2937; }
  .btn { font-weight: 500; }
  .btn-primary { background-color: #6d28d9; border-color: #6d28d9; }
  .btn-primary:hover { background-color: #5b21b6; border-color: #5b21b6; }
  .btn-secondary { background-color: #374151; border-color: #374151; color: #ffffff; }
  .btn-secondary:hover { background-color: #4b5563; border-color: #4b5563; }
  .grid { display:grid; gap:1rem; grid-template-columns: repeat(12,minmax(0,1fr)); }
  .col-span-12 { grid-column: span 12 / span 12; }
  .col-span-6 { grid-column: span 6 / span 6; }
  .col-span-4 { grid-column: span 4 / span 4; }
  .col-span-3 { grid-column: span 3 / span 3; }
  @media (max-width: 992px){
    .layout { grid-template-columns: 84px 1fr; }
    .brand-text, .nav-text { display:none; }
  }

  /* --- Estilo "documento" para relatórios --- */
  .doc-card {
    background: linear-gradient(135deg, #020617, #0b1220);
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.25);
    padding: 1.1rem 1.2rem;
    margin-bottom: 1rem;
  }
  .doc-header {
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:1rem;
    margin-bottom:.75rem;
  }
  .doc-title {
    font-size: .95rem;
    font-weight: 600;
    color:#e5e7eb;
  }
  .doc-subtitle {
    font-size: 1.25rem;
    font-weight: 700;
    color:#f1f5f9;
    margin-top: 0.25rem;
  }
  .doc-mini {
    font-size: .8rem;
    color:#94a3b8;
    margin-top: 0.35rem;
  }
  .doc-meta {
    text-align:right;
    font-size:.75rem;
    color:#9ca3af;
  }
  .doc-badge {
    display:inline-flex;
    align-items:center;
    gap:.35rem;
    padding:.2rem .55rem;
    border-radius:999px;
    font-size:.7rem;
    background:rgba(129, 140, 248, .16);
    color:#c7d2fe;
  }
  .doc-badge.dot::before {
    content:"";
    width:.45rem; height:.45rem;
    border-radius:999px;
    background:#22c55e;
  }
  .doc-section-title {
    font-size:.8rem;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:#9ca3af;
    margin:.35rem 0 .25rem;
  }
  .doc-section-title span {
    color:#e5e7eb;
    text-transform:none;
    letter-spacing:0;
    margin-left:.35rem;
    font-weight:500;
  }
  .doc-table-wrapper {
    border-radius:10px;
    border:1px solid rgba(55, 65, 81, .8);
    overflow:hidden;
    background:#020617;
  }
  .doc-table-wrapper .table {
    margin-bottom:0;
  }
  .doc-footer-note {
    font-size:.75rem;
    color:#6b7280;
    margin-top:.5rem;
  }
  .os-header-line {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:1rem;
    margin-bottom:.25rem;
  }
  .os-title {
    font-weight:600;
    font-size:.9rem;
    color:#e5e7eb;
  }
  .os-status-pill {
    font-size:.7rem;
    padding:.2rem .6rem;
    border-radius:999px;
    text-transform:uppercase;
    letter-spacing:.08em;
  }
  .os-status-pill.em_execucao { background:rgba(59,130,246,.2); color:#bfdbfe; }
  .os-status-pill.aberto      { background:rgba(234,179,8,.15); color:#facc15; }
  .os-status-pill.finalizado  { background:rgba(34,197,94,.18); color:#bbf7d0; }
  .os-meta-line {
    font-size:.78rem;
    color:#9ca3af;
    margin-bottom:.5rem;
  }
  /* Deixa o card flutuando um pouco */
  .card {
    border-radius: 14px;
    box-shadow: 0 20px 30px rgba(15, 23, 42, 0.65);
  }

  /* Área central mais "app" do que site fullscreen */
  .content {
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Tabelas mais limpas */
  .table {
    border-collapse: separate;
    border-spacing: 0 4px;
  }
  .table tbody tr {
    border-radius: 8px;
    transition: background 0.15s ease, transform 0.05s ease;
  }
  .table tbody tr:hover {
    background: rgba(55, 65, 81, 0.7);
    transform: translateY(-1px);
  }
  .table td, .table th {
    border: none !important;
  }

  /* Nav lateral com indicador */
  .nav-link {
    position: relative;
  }
  .nav-link.active::before {
    content: "";
    position: absolute;
    left: 0;
    top: 6px;
    bottom: 6px;
    width: 3px;
    border-radius: 999px;
    background: #fbbf24;
  }

  /* Cabeçalho das seções com linha colorida */
  .section-title {
    border-bottom: 1px solid rgba(148, 163, 184, 0.35);
    padding-bottom: .4rem;
    margin-bottom: 1rem;
  }
  /* Status de agendamento em formato pill */
  .status-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.12rem 0.55rem;
    border-radius: 999px;
    font-size: 0.75rem;
    letter-spacing: .03em;
    text-transform: uppercase;
    font-weight: 600;
  }
  .status-confirmado {
    background: rgba(34, 197, 94, 0.18);
    color: #bbf7d0;
  }
  .status-pendente {
    background: rgba(250, 204, 21, 0.18);
    color: #facc15;
  }
  .status-cancelado {
    background: rgba(239, 68, 68, 0.2);
    color: #fecaca;
  }

  /* ===== Layout estilo documento para relatórios impressos ===== */
  .os-doc{
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    color: #e2e8f0;
    border-radius: 16px;
    border: 1px solid #334155;
    padding: 2rem;
    margin-bottom: 2rem;
    font-size: 0.95rem;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
  }
  .os-doc-header{
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 2rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid #334155;
  }
  .os-doc-title{
    font-weight: 700;
    letter-spacing: 0.08em;
    font-size: 1.1rem;
    text-transform: uppercase;
    color: #94a3b8;
    margin-bottom: 0.5rem;
  }
  .os-doc-subtitle{
    font-size: 1.5rem;
    font-weight: 600;
    color: #f1f5f9;
    margin-bottom: 0.25rem;
  }
  .os-doc-meta{
    text-align: right;
    font-size: 0.9rem;
  }
  .os-doc-status{
    display: inline-block;
    padding: 0.4rem 1rem;
    border-radius: 999px;
    background: #3b82f6;
    color: #ffffff;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    margin-bottom: 0.5rem;
  }
  .os-doc-total{
    font-size: 1.25rem;
    font-weight: 700;
    color: #22c55e;
  }
  .os-doc-mini{
    margin-top: 0.25rem;
    color: #cbd5e1;
    font-size: 0.9rem;
  }
  .os-doc-table{
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    table-layout: fixed;
  }
  .os-doc-table th,
  .os-doc-table td{
    border: 1px solid #334155;
    padding: 1rem 1.5rem;
    vertical-align: middle;
    white-space: normal;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .os-doc-section-row th{
    background: #6366f1;
    text-transform: uppercase;
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    color: #ffffff;
    padding: 1.25rem 1.5rem;
  }
  .os-doc-table thead th{
    background: #6366f1;
    color: #ffffff;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 1rem 1.5rem;
  }
  
  /* Tabela de serviços (3 colunas): Descrição | Qtd | Valor */
  .os-doc-table thead th:nth-child(1):not([colspan]),
  .os-doc-table tbody tr:has(+ tr[class="os-doc-section-row"]) td:nth-child(1),
  .os-doc-table tr:not(.os-doc-section-row):has(~ .os-doc-section-row:nth-of-type(2)) td:nth-child(1) {
    width: 60%;
  }
  .os-doc-table thead th:nth-child(2):not([colspan]),
  .os-doc-table tbody tr:has(+ tr[class="os-doc-section-row"]) td:nth-child(2),
  .os-doc-table tr:not(.os-doc-section-row):has(~ .os-doc-section-row:nth-of-type(2)) td:nth-child(2) {
    width: 15%;
    text-align: center;
  }
  .os-doc-table thead th:nth-child(3):not([colspan]),
  .os-doc-table tbody tr:has(+ tr[class="os-doc-section-row"]) td:nth-child(3),
  .os-doc-table tr:not(.os-doc-section-row):has(~ .os-doc-section-row:nth-of-type(2)) td:nth-child(3) {
    width: 25%;
    text-align: right;
  }
  
  /* Tabela de peças (4 colunas): Peça | Origem | Qtd | Valor */
  .os-doc-section-row:nth-of-type(2) ~ thead th:nth-child(1),
  .os-doc-section-row:nth-of-type(2) ~ tbody td:nth-child(1) {
    width: 40%;
  }
  .os-doc-section-row:nth-of-type(2) ~ thead th:nth-child(2),
  .os-doc-section-row:nth-of-type(2) ~ tbody td:nth-child(2) {
    width: 20%;
    text-align: center;
  }
  .os-doc-section-row:nth-of-type(2) ~ thead th:nth-child(3),
  .os-doc-section-row:nth-of-type(2) ~ tbody td:nth-child(3) {
    width: 15%;
    text-align: center;
  }
  .os-doc-section-row:nth-of-type(2) ~ thead th:nth-child(4),
  .os-doc-section-row:nth-of-type(2) ~ tbody td:nth-child(4) {
    width: 25%;
    text-align: right;
  }
  
  /* Tabela de pagamentos (3 colunas): Data | Forma | Valor */
  .os-doc-section-row:nth-of-type(3) ~ thead th:nth-child(1),
  .os-doc-section-row:nth-of-type(3) ~ tbody td:nth-child(1) {
    width: 35%;
    text-align: center;
  }
  .os-doc-section-row:nth-of-type(3) ~ thead th:nth-child(2),
  .os-doc-section-row:nth-of-type(3) ~ tbody td:nth-child(2) {
    width: 40%;
    text-align: center;
  }
  .os-doc-section-row:nth-of-type(3) ~ thead th:nth-child(3),
  .os-doc-section-row:nth-of-type(3) ~ tbody td:nth-child(3) {
    width: 25%;
    text-align: right;
  }
  .os-doc-label{
    width: 26%;
    font-weight: 500;
    background: #1e293b;
  }
  .os-doc-inner{
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }
  .os-doc-inner th,
  .os-doc-inner td{
    border: 1px solid #334155;
    padding: 0.5rem 0.75rem;
  }
  .os-doc-footer{
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 2px solid #334155;
    font-size: 0.9rem;
    color: #94a3b8;
  }
  .os-doc-footer > div{
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .os-doc-footer strong{
    color: #cbd5e1;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .os-doc-ass{
    text-align: right;
  }
  .os-doc-resumo{
    font-size: 0.95rem;
    margin-bottom: 1rem;
    color: #cbd5e1;
  }
  .os-doc-empty{
    color: #64748b;
    padding: 2rem;
    text-align: center;
    font-style: italic;
  }

@media print {
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  html, body {
    background: #ffffff !important;
    color: #000000 !important;
    margin: 0;
    padding: 0;
  }

  /* Esconde tudo por padrão */
  .sidebar, nav, .btn, .form-select, .form-label, .section-title, .d-flex {
    display: none !important;
  }

  .layout, main {
    display: block !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  main > section {
    display: none !important;
  }

  #section-relatorios {
    display: block !important;
    margin: 0 !important;
    padding: 10mm 15mm !important;
  }

  .grid {
    display: block !important;
  }

  /* Esconde ambos os relatórios por padrão */
  .grid > div {
    display: none !important;
  }

  /* Mostra apenas o relatório 3.1 quando data-print-report='31' */
  body[data-print-report='31'] .grid > .col-span-12:first-child,
  body[data-print-report='31'] .grid > .col-lg-6:first-child {
    display: block !important;
  }

  /* Mostra apenas o relatório 3.3 quando data-print-report='33' */
  body[data-print-report='33'] .grid > .col-span-12:last-child {
    display: block !important;
  }

  .card {
    background: #ffffff !important;
    border: 2px solid #555555 !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    padding: 10mm !important;
    margin: 0 !important;
  }

  /* Estilos para relatório 3.1 - Formato documento formal */
  body[data-print-report='31'] #rel31-table {
    display: block !important;
  }

  body[data-print-report='31'] .doc-card {
    display: block !important;
    background: #ffffff !important;
    border: 2px solid #555555 !important;
    padding: 10mm !important;
    margin: 0 !important;
    border-radius: 0 !important;
    box-shadow: none !important;
  }

  body[data-print-report='31'] .doc-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: flex-start !important;
    padding-bottom: 6mm !important;
    margin-bottom: 6mm !important;
    border-bottom: 3px solid #666666 !important;
  }

  body[data-print-report='31'] .doc-title {
    font-size: 10pt !important;
    font-weight: 700 !important;
    color: #333333 !important;
    text-transform: uppercase !important;
    letter-spacing: 1px !important;
    margin-bottom: 2mm !important;
  }

  body[data-print-report='31'] .doc-subtitle {
    font-size: 14pt !important;
    font-weight: 700 !important;
    color: #000000 !important;
  }

  body[data-print-report='31'] .doc-mini {
    font-size: 9pt !important;
    color: #333333 !important;
    margin-top: 2mm !important;
  }

  body[data-print-report='31'] .doc-meta {
    display: block !important;
    text-align: right !important;
    font-size: 9pt !important;
    color: #333333 !important;
  }

  body[data-print-report='31'] .doc-meta > div {
    margin-bottom: 1mm !important;
  }

  body[data-print-report='31'] .doc-badge {
    display: inline-block !important;
    background: #666666 !important;
    color: #ffffff !important;
    padding: 2mm 4mm !important;
    margin-top: 2mm !important;
    font-size: 8pt !important;
    font-weight: 700 !important;
    text-transform: uppercase !important;
  }

  body[data-print-report='31'] .doc-badge .dot {
    display: none !important;
  }

  body[data-print-report='31'] .doc-section-title {
    display: block !important;
    font-size: 9pt !important;
    font-weight: 700 !important;
    color: #000000 !important;
    text-transform: uppercase !important;
    margin-bottom: 3mm !important;
    padding-bottom: 2mm !important;
    border-bottom: 1px solid #666666 !important;
  }

  body[data-print-report='31'] .doc-section-title span {
    font-weight: 400 !important;
    color: #666666 !important;
    text-transform: none !important;
    font-size: 8pt !important;
  }

  body[data-print-report='31'] .doc-table-wrapper {
    display: block !important;
  }

  body[data-print-report='31'] .doc-table-wrapper table {
    width: 100% !important;
    max-width: 100% !important;
    border-collapse: collapse !important;
    background: #ffffff !important;
    table-layout: fixed !important;
  }

  body[data-print-report='31'] .doc-table-wrapper th,
  body[data-print-report='31'] .doc-table-wrapper td {
    border: 1.5px solid #666666 !important;
    padding: 2mm 3mm !important;
    color: #000000 !important;
    background: #ffffff !important;
    font-size: 9pt !important;
  }

  body[data-print-report='31'] .doc-table-wrapper th {
    background: #666666 !important;
    color: #ffffff !important;
    font-weight: 700 !important;
    text-transform: uppercase !important;
    font-size: 9pt !important;
    letter-spacing: 0.5px !important;
    padding: 3mm !important;
  }

  body[data-print-report='31'] .doc-table-wrapper tbody tr:nth-child(even) {
    background: #f9f9f9 !important;
  }

  body[data-print-report='31'] .doc-footer-note {
    display: block !important;
    margin-top: 6mm !important;
    padding-top: 6mm !important;
    border-top: 2px solid #666666 !important;
    font-size: 8pt !important;
    color: #333333 !important;
    line-height: 1.4 !important;
  }

  /* Estilos para relatório 3.3 */
  body[data-print-report='33'] #rel33-blocos {
    display: block !important;
  }

  .os-doc {
    background: #ffffff !important;
    color: #000000 !important;
    border: 2px solid #555555 !important;
    border-radius: 0 !important;
    padding: 10mm !important;
    margin-bottom: 8mm !important;
    page-break-inside: avoid;
    box-shadow: none !important;
    display: block !important;
  }

  .os-doc-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: flex-start !important;
    padding-bottom: 6mm !important;
    margin-bottom: 6mm !important;
    border-bottom: 3px solid #666666 !important;
  }

  .os-doc-title {
    font-size: 10pt !important;
    font-weight: 700 !important;
    color: #333333 !important;
    text-transform: uppercase !important;
    letter-spacing: 1px !important;
    margin-bottom: 2mm !important;
  }

  .os-doc-subtitle {
    font-size: 14pt !important;
    font-weight: 700 !important;
    color: #000000 !important;
    margin-bottom: 2mm !important;
  }

  .os-doc-mini {
    font-size: 9pt !important;
    color: #333333 !important;
  }

  .os-doc-meta {
    display: block !important;
    text-align: right !important;
  }

  .os-doc-status {
    display: inline-block !important;
    background: #666666 !important;
    color: #ffffff !important;
    padding: 2mm 5mm !important;
    border-radius: 0 !important;
    font-size: 8pt !important;
    font-weight: 700 !important;
    text-transform: uppercase !important;
    margin-bottom: 2mm !important;
  }

  .os-doc-total {
    font-size: 12pt !important;
    font-weight: 700 !important;
    color: #000000 !important;
    display: block !important;
  }

  .os-doc-table {
    width: 100% !important;
    max-width: 100% !important;
    border-collapse: collapse !important;
    margin-top: 4mm !important;
    background: #ffffff !important;
    display: table !important;
    table-layout: fixed !important;
  }

  .os-doc-table th,
  .os-doc-table td {
    border: 1.5px solid #666666 !important;
    padding: 2mm 3mm !important;
    color: #000000 !important;
    background: #ffffff !important;
    font-size: 9pt !important;
    word-wrap: break-word !important;
  }

  .os-doc-section-row th {
    background: #666666 !important;
    color: #ffffff !important;
    font-weight: 700 !important;
    font-size: 9pt !important;
    text-transform: uppercase !important;
    padding: 3mm !important;
    letter-spacing: 0.5px !important;
  }

  .os-doc-table thead th {
    background: #f5f5f5 !important;
    color: #000000 !important;
    font-weight: 700 !important;
    font-size: 8pt !important;
    border-bottom: 2px solid #666666 !important;
  }

  .os-doc-footer {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 4mm !important;
    margin-top: 6mm !important;
    padding-top: 6mm !important;
    border-top: 2px solid #666666 !important;
    color: #333333 !important;
    font-size: 8pt !important;
  }

  .os-doc-footer > div {
    display: block !important;
  }

  .os-doc-footer strong {
    color: #000000 !important;
    font-size: 7pt !important;
    text-transform: uppercase !important;
    display: block !important;
    margin-bottom: 1mm !important;
    letter-spacing: 0.5px !important;
  }
}

</style>
</head>
<body>

<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand d-flex align-items-center gap-2 mb-3">
      <i class="bi bi-tools fs-5"></i>
      <span class="brand-text">Oficina do seu Zé</span>
    </div>
    <nav class="nav flex-column gap-1">
      <a class="nav-link active" data-section="home"><i class="bi bi-house"></i><span class="nav-text">Início</span></a>
      <a class="nav-link" data-section="veiculos"><i class="bi bi-car-front"></i><span class="nav-text">Veículos</span></a>
      <a class="nav-link" data-section="clientes"><i class="bi bi-people"></i><span class="nav-text">Clientes</span></a>
      <a class="nav-link" data-section="funcionarios"><i class="bi bi-person-badge"></i><span class="nav-text">Funcionários</span></a>
      <a class="nav-link" data-section="servicos"><i class="bi bi-clipboard2-check"></i><span class="nav-text">Serviços</span></a>
      <a class="nav-link" data-section="pecas"><i class="bi bi-gear"></i><span class="nav-text">Peças</span></a>
      <a class="nav-link" data-section="agendamentos"><i class="bi bi-calendar2-week"></i><span class="nav-text">Agendamentos</span></a>
      <a class="nav-link" data-section="relatorios"><i class="bi bi-graph-up"></i><span class="nav-text">Relatórios</span></a>
      <a class="nav-link" data-section="fornecedores"><i class="bi bi-truck"></i><span class="nav-text">Fornecedores & Estoque</span></a>
    </nav>
  </aside>

  <!-- CONTEÚDO -->
  <main class="content">
    <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <div class="small text-uppercase" style="letter-spacing:.12em; color:#9ca3af;">Oficina do seu Zé</div>
      <div class="h5 mb-0 text-white">Painel de operações</div>
      <div class="muted">Consultas, cadastros e relatórios em um só lugar</div>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-light btn-sm" id="btn-recarregar-combos">
          <i class="bi bi-arrow-repeat me-1"></i>Recarregar dados
        </button>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAgendar">
          <i class="bi bi-plus-circle me-1"></i>Novo Agendamento
        </button>
      </div>
    </div>

    <!-- HOME -->
    <section id="section-home">
      <div class="grid">
        <div class="col-span-12 col-lg-6">
          <div class="card p-3">
            <div class="section-title"><i class="bi bi-speedometer2"></i><h6 class="mb-0">Atalhos</h6></div>
            <div class="d-grid gap-2">
              <button class="btn btn-secondary btn-sm" data-goto="veiculos">Listar Veículos</button>
              <button class="btn btn-secondary btn-sm" data-goto="clientes">Listar Clientes</button>
              <button class="btn btn-secondary btn-sm" data-goto="servicos">Listar Serviços</button>
              <button class="btn btn-secondary btn-sm" data-goto="pecas">Listar Peças</button>
              <button class="btn btn-secondary btn-sm" data-goto="agendamentos">Ver Agendamentos</button>
            </div>
          </div>
        </div>
        <div class="col-span-12 col-lg-6">
          <div class="card p-3">
            <div class="section-title"><i class="bi bi-info-circle"></i><h6 class="mb-0">Como usar</h6></div>
            <div class="small muted">
              Use o menu à esquerda para navegar. Cada seção carrega dados da API Flask.<br>
              Botões abrem popups para consultas específicas (3.1 e 3.3) e novo agendamento (3.2).
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- VEÍCULOS -->
    <section id="section-veiculos" class="d-none">
      <div class="card p-3 mb-3">
        <div class="section-title"><i class="bi bi-plus-circle"></i><h6 class="mb-0">Novo Veículo</h6></div>
        <form id="form-veiculo" class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Placa</label>
            <input type="text" class="form-control" id="veiPlaca" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Marca</label>
            <input type="text" class="form-control" id="veiMarca" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Modelo</label>
            <input type="text" class="form-control" id="veiModelo" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Km atual</label>
            <input type="number" class="form-control" id="veiKm" min="0">
          </div>
          <div class="col-md-6">
            <label class="form-label">Cliente</label>
            <select class="form-select" id="veiCliente" required></select>
          </div>
          <div class="col-12 text-end">
            <button class="btn btn-primary btn-sm" type="submit">Salvar veículo</button>
          </div>
        </form>
      </div>

      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="section-title mb-0">
            <i class="bi bi-car-front"></i><h6 class="mb-0">Veículos cadastrados</h6>
          </div>
          <div class="input-group input-group-sm" style="max-width:260px;">
            <input type="text" class="form-control" id="busca-veiculos"
                   placeholder="Buscar por placa, modelo ou cliente">
            <button class="btn btn-secondary" id="btn-buscar-veiculos">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
        <div id="veiculos-table" class="table-responsive"></div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="section-clientes" class="d-none">
      <div class="card p-3 mb-3">
        <div class="section-title"><i class="bi bi-plus-circle"></i><h6 class="mb-0">Novo Cliente</h6></div>
        <form id="form-cliente" class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Nome / Razão social</label>
            <input type="text" class="form-control" id="cliNome" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">CPF / CNPJ</label>
            <input type="text" class="form-control" id="cliCpf" required>
          </div>
          <div class="col-12 text-end">
            <button class="btn btn-primary btn-sm" type="submit">Salvar cliente</button>
          </div>
        </form>
      </div>

      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="section-title mb-0">
            <i class="bi bi-people"></i><h6 class="mb-0">Clientes cadastrados</h6>
          </div>
          <div class="input-group input-group-sm" style="max-width:260px;">
            <input type="text" class="form-control" id="busca-clientes"
                   placeholder="Buscar por nome ou CPF/CNPJ">
            <button class="btn btn-secondary" id="btn-buscar-clientes">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
        <div id="clientes-table" class="table-responsive"></div>
      </div>
    </section>

    <!-- FUNCIONÁRIOS -->
    <section id="section-funcionarios" class="d-none">
      <div class="card p-3 mb-3">
        <div class="section-title"><i class="bi bi-plus-circle"></i><h6 class="mb-0">Novo Funcionário</h6></div>
        <form id="form-funcionario" class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Nome</label>
            <input type="text" class="form-control" id="funNome" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Função</label>
            <input type="text" class="form-control" id="funFuncao">
          </div>
          <div class="col-12 text-end">
            <button class="btn btn-primary btn-sm" type="submit">Salvar funcionário</button>
          </div>
        </form>
      </div>

      <div class="card p-3">
        <div class="section-title"><i class="bi bi-person-badge"></i><h6 class="mb-0">Funcionários cadastrados</h6></div>
        <div id="func-table" class="table-responsive"></div>
      </div>
    </section>

    <!-- SERVIÇOS -->
    <section id="section-servicos" class="d-none">
      <div class="card p-3 mb-3">
        <div class="section-title"><i class="bi bi-plus-circle"></i><h6 class="mb-0">Novo Serviço</h6></div>
        <form id="form-servico" class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Descrição</label>
            <input type="text" class="form-control" id="serDesc" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Preço padrão</label>
            <input type="number" step="0.01" class="form-control" id="serPreco">
          </div>
          <div class="col-12 text-end">
            <button class="btn btn-primary btn-sm" type="submit">Salvar serviço</button>
          </div>
        </form>
      </div>

      <div class="card p-3">
        <div class="section-title"><i class="bi bi-clipboard2-check"></i><h6 class="mb-0">Serviços cadastrados</h6></div>
        <div id="servicos-table" class="table-responsive"></div>
      </div>
    </section>

    <!-- PEÇAS -->
    <section id="section-pecas" class="d-none">
      <div class="card p-3 mb-3">
        <div class="section-title"><i class="bi bi-plus-circle"></i><h6 class="mb-0">Nova Peça</h6></div>
        <form id="form-peca" class="row g-2">
          <div class="col-md-3">
            <label class="form-label">SKU</label>
            <input type="text" class="form-control" id="pecSku" required>
          </div>
          <div class="col-md-5">
            <label class="form-label">Descrição</label>
            <input type="text" class="form-control" id="pecDesc" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">Origem</label>
            <select class="form-select" id="pecOrigem">
              <option value="nacional">Nacional</option>
              <option value="importada">Importada</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Estoque inicial</label>
            <input type="number" class="form-control" id="pecEstoque" value="0" min="0">
          </div>
          <div class="col-12 text-end">
            <button class="btn btn-primary btn-sm" type="submit">Salvar peça</button>
          </div>
        </form>
      </div>

      <div class="card p-3">
        <div class="section-title"><i class="bi bi-gear"></i><h6 class="mb-0">Peças cadastradas</h6></div>
        <div id="pecas-table" class="table-responsive"></div>
      </div>
    </section>

    <!-- AGENDAMENTOS -->
    <section id="section-agendamentos" class="d-none">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="section-title mb-0"><i class="bi bi-calendar2-week"></i><h6 class="mb-0">Agendamentos</h6></div>
          <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAgendar">
            <i class="bi bi-plus-circle me-1"></i>Novo
          </button>
        </div>
        <div id="ag-table" class="table-responsive mt-2"></div>
      </div>
    </section>

    <!-- RELATÓRIOS -->
    <section id="section-relatorios" class="d-none">
      <div class="section-title mb-3">
        <i class="bi bi-graph-up"></i>
        <h6 class="mb-0">Relatórios</h6>
      </div>
      <div class="grid">
        <!-- 3.1 Peças + complexidade -->
        <div class="col-span-12 col-lg-6">
          <div class="card p-3 h-100">
            <div class="section-title">
              <i class="bi bi-list-ul"></i>
              <h6 class="mb-0">Relatório 3.1 – Peças por Veículo &amp; Complexidade</h6>
            </div>

            <div class="mb-2">
              <label class="form-label small mb-1">Selecione o veículo</label>
              <select id="sel-pd-veiculo" class="form-select form-select-sm"></select>
            </div>

            <button class="btn btn-secondary btn-sm mb-3 w-100" id="btn-rel-31">
              <i class="bi bi-search me-1"></i>Gerar relatório
            </button>

            <button class="btn btn-outline-light btn-sm mb-3 w-100 d-none" id="btn-pdf-31">
              <i class="bi bi-printer me-1"></i>Exportar PDF
            </button>

            <div id="rel31-table"></div>
          </div>
        </div>

        <!-- 3.3 Histórico de manutenção (documento) -->
        <div class="col-span-12">
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">
                <i class="bi bi-clock-history"></i>
                <h6 class="mb-0">Relatório 3.3 – Histórico de Manutenção por Veículo</h6>
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label small mb-1">Selecione o veículo</label>
              <select id="sel-hist-veiculo" class="form-select form-select-sm"></select>
            </div>

            <button class="btn btn-secondary btn-sm mb-3 w-100" id="btn-rel-33">
              <i class="bi bi-file-text me-1"></i>Emitir relatório
            </button>

            <button class="btn btn-outline-light btn-sm mb-3 w-100 d-none" id="btn-pdf-33">
              <i class="bi bi-printer me-1"></i>Exportar PDF
            </button>

            <div id="rel33-blocos"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- FORNECEDORES & ESTOQUE -->
    <section id="section-fornecedores" class="d-none">
      <div class="grid">
        <div class="col-span-12 col-lg-6">
          <div class="card p-3 mb-3">
            <div class="section-title"><i class="bi bi-plus-circle"></i><h6 class="mb-0">Novo Fornecedor</h6></div>
            <form id="form-fornecedor" class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Nome/Razão social</label>
                <input type="text" class="form-control" id="fornNome" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">CPF/CNPJ</label>
                <input type="text" class="form-control" id="fornCpf">
              </div>
              <div class="col-12 text-end">
                <button class="btn btn-primary btn-sm" type="submit">Salvar fornecedor</button>
              </div>
            </form>
          </div>

          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">
                <i class="bi bi-truck"></i><h6 class="mb-0">Fornecedores</h6>
              </div>
              <div class="input-group input-group-sm" style="max-width:260px;">
                <input type="text" class="form-control" id="busca-fornecedores"
                       placeholder="Buscar por nome ou CPF/CNPJ">
                <button class="btn btn-secondary" id="btn-buscar-fornecedores">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
            <div id="fornec-table" class="table-responsive"></div>
          </div>
        </div>
        <div class="col-span-12 col-lg-6">
          <div class="card p-3">
            <div class="section-title"><i class="bi bi-arrow-left-right"></i><h6 class="mb-0">Movimentos de Estoque</h6></div>
            <div id="mov-table" class="table-responsive"></div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- MODAL: NOVO AGENDAMENTO (3.2) -->
<div class="modal fade" id="modalAgendar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Novo Agendamento</h5>
      <button class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
    </div>
    <div class="modal-body">
      <div class="vstack gap-2">
        <div>
          <label class="form-label">Cliente</label>
          <select class="form-select" id="agCliente"></select>
        </div>
        <div>
          <label class="form-label">Veículo</label>
          <select class="form-select" id="agVeiculo" disabled></select>
        </div>
        <div>
          <label class="form-label">Serviço</label>
          <select class="form-select" id="agServico"></select>
        </div>
        <div>
          <label class="form-label">Data e Hora</label>
          <input type="datetime-local" class="form-control" id="agDataHora" required>
        </div>
        <div class="small text-warning">* Conflito de horário por veículo é validado no backend.</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      <button class="btn btn-primary" id="btnSalvarAg">Salvar</button>
    </div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/api.js"></script>

<script>
  // ---------- Navegação SPA ----------
  const links = document.querySelectorAll('.nav-link');
  const sections = [...document.querySelectorAll('main > section')];
  let veiculosCache = [];
  let clientesCache = [];
  let fornecedoresCache = [];

  function showSection(name){
    links.forEach(l => l.classList.toggle('active', l.dataset.section===name));
    sections.forEach(s => s.classList.toggle('d-none', s.id !== 'section-'+name));

    if(name==='veiculos') { carregarVeiculos(); preloadVeiculoClientes(); }
    if(name==='clientes') carregarClientes();
    if(name==='funcionarios') carregarFuncionarios();
    if(name==='servicos') carregarServicos();
    if(name==='pecas') carregarPecas();
    if(name==='agendamentos') carregarAgendamentos();
    if(name==='relatorios') preloadCombosRel();
    if(name==='fornecedores') { carregarFornecedores(); carregarMovimentos(); }
  }
  links.forEach(l=>l.addEventListener('click',()=>showSection(l.dataset.section)));
  document.querySelectorAll('[data-goto]').forEach(b=>b.addEventListener('click',()=>showSection(b.dataset.goto)));

  // ---------- Helpers UI ----------
  function table(headers, bodyHtml){
    return `
      <table class="table table-sm align-middle">
        <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
        <tbody>${bodyHtml||''}</tbody>
      </table>`;
  }

  // ---------- Carregamentos ----------
  function renderVeiculosTable(lista){
    const rows = (lista || []).map(v => `
      <tr>
        <td>${v.placa}</td>
        <td>${v.marca}</td>
        <td>${v.modelo}</td>
        <td>${v.cliente.nome}</td>
        <td>
          <button class="btn btn-outline-light btn-sm me-1" onclick="consultaHistoricoCompleto(${v.id_veiculo})"><i class="bi bi-clock-history"></i></button>
          <button class="btn btn-outline-primary btn-sm" onclick="consultaPecas(${v.id_veiculo})"><i class="bi bi-gear"></i></button>
        </td>
      </tr>`).join('');
    document.getElementById('veiculos-table').innerHTML =
      table(["Placa","Marca","Modelo","Cliente","Ações"], rows);
  }

  async function carregarVeiculos(){
    const data = await apiGet("/veiculos");
    veiculosCache = data;
    renderVeiculosTable(data);
  }

  document.getElementById('btn-buscar-veiculos').addEventListener('click', () => {
    const termo = document.getElementById('busca-veiculos').value.trim().toLowerCase();
    if (!termo) {
      renderVeiculosTable(veiculosCache);
      return;
    }
    const filtrados = veiculosCache.filter(v =>
      (v.placa || '').toLowerCase().includes(termo) ||
      (v.marca || '').toLowerCase().includes(termo) ||
      (v.modelo || '').toLowerCase().includes(termo) ||
      ((v.cliente?.nome || '').toLowerCase().includes(termo))
    );
    renderVeiculosTable(filtrados);
  });

  document.getElementById('busca-veiculos').addEventListener('keyup', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('btn-buscar-veiculos').click();
    }
  });

  async function preloadVeiculoClientes(){
    const clientes = await apiGet("/clientes");
    const sel = document.getElementById('veiCliente');
    sel.innerHTML = clientes.map(c =>
      `<option value="${c.id_cliente}">${c.nome_razao} (${c.cpf_cnpj})</option>`
    ).join('');
  }

  function renderClientesTable(lista){
    const rows = (lista || []).map(c =>
      `<tr>
        <td>${c.id_cliente}</td>
        <td>${c.nome_razao}</td>
        <td>${c.cpf_cnpj}</td>
      </tr>`
    ).join('');
    document.getElementById('clientes-table').innerHTML =
      table(["ID","Nome/Razão","CPF/CNPJ"], rows);
  }

  async function carregarClientes(){
    const data = await apiGet("/clientes");
    clientesCache = data;
    renderClientesTable(data);
  }

  document.getElementById('btn-buscar-clientes').addEventListener('click', () => {
    const termo = document.getElementById('busca-clientes').value.trim().toLowerCase();
    if (!termo) {
      renderClientesTable(clientesCache);
      return;
    }
    const filtrados = clientesCache.filter(c =>
      (c.nome_razao || '').toLowerCase().includes(termo) ||
      (c.cpf_cnpj || '').toLowerCase().includes(termo)
    );
    renderClientesTable(filtrados);
  });

  document.getElementById('busca-clientes').addEventListener('keyup', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('btn-buscar-clientes').click();
    }
  });

  async function carregarFuncionarios(){
    const data = await apiGet("/funcionarios");
    const rows = data.map(f=>`<tr><td>${f.id_funcionario}</td><td>${f.nome}</td><td>${f.funcao||''}</td></tr>`).join('');
    document.getElementById('func-table').innerHTML =
      table(["ID","Nome","Função"], rows);
  }

  async function carregarServicos(){
    const data = await apiGet("/servicos");
    const rows = data.map(s=>`<tr><td>${s.id_servico}</td><td>${s.descricao}</td><td>${s.preco_padrao}</td></tr>`).join('');
    document.getElementById('servicos-table').innerHTML =
      table(["ID","Descrição","Preço padrão"], rows);
  }

  async function carregarPecas(){
    const data = await apiGet("/pecas");
    const rows = data.map(p=>`<tr><td>${p.id_peca}</td><td>${p.descricao}</td><td>${p.origem}</td><td>${p.estoque_atual}</td></tr>`).join('');
    document.getElementById('pecas-table').innerHTML =
      table(["ID","Peça","Origem","Estoque"], rows);
  }

  async function carregarAgendamentos(){
    const data = await apiGet("/agendamentos");

    const statusPill = (status) => {
      const s = (status || "").toLowerCase();
      let cls = "status-pendente";
      if (s.includes("confirm")) cls = "status-confirmado";
      else if (s.includes("cancel")) cls = "status-cancelado";
      return `<span class="status-pill ${cls}">${status}</span>`;
    };

    const rows = data.map(a=>`
      <tr>
        <td>${a.id_agendamento}</td>
        <td>${(a.data_hora||'').replace('T',' ')}</td>
        <td>${statusPill(a.status)}</td>
        <td>${a.cliente}</td>
        <td>${a.veiculo}</td>
        <td>${a.servico}</td>
      </tr>`).join('');

    document.getElementById('ag-table').innerHTML =
      table(["ID","Data/Hora","Status","Cliente","Veículo","Serviço"], rows);
  }

  function renderFornecedoresTable(lista){
    const rows = (lista || []).map(f => `
      <tr>
        <td>${f.id_fornecedor}</td>
        <td>${f.nome_razao}</td>
        <td>${f.cpf_cnpj || ''}</td>
      </tr>`).join('');
    document.getElementById('fornec-table').innerHTML =
      table(["ID","Fornecedor","CPF/CNPJ"], rows);
  }

  async function carregarFornecedores(){
    const data = await apiGet("/fornecedores");
    fornecedoresCache = data;
    renderFornecedoresTable(data);
  }
  
  document.getElementById('btn-buscar-fornecedores').addEventListener('click', () => {
    const termo = document.getElementById('busca-fornecedores').value.trim().toLowerCase();
    if (!termo) {
      renderFornecedoresTable(fornecedoresCache);
      return;
    }
    const filtrados = fornecedoresCache.filter(f =>
      (f.nome_razao || '').toLowerCase().includes(termo) ||
      (f.cpf_cnpj || '').toLowerCase().includes(termo)
    );
    renderFornecedoresTable(filtrados);
  });

  document.getElementById('busca-fornecedores').addEventListener('keyup', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('btn-buscar-fornecedores').click();
    }
  });

  async function carregarMovimentos(){
    const data = await apiGet("/movimentos-estoque");
    const rows = data.map(m=>`
      <tr>
        <td>${m.id_movimento}</td>
        <td>${(m.data||'').replace('T',' ').slice(0,16)}</td>
        <td>${m.tipo}</td>
        <td>${m.origem||''}</td>
        <td>${m.qtd}</td>
        <td>${m.custo_unitario||''}</td>
        <td>${m.peca?.descricao||''}</td>
        <td>${m.id_os||''}</td>
      </tr>`).join('');
    document.getElementById('mov-table').innerHTML =
      table(["ID","Data","Tipo","Origem","Qtd","Custo Unit.","Peça","OS"], rows);
  }

  // ---------- Relatórios ----------
  async function preloadCombosRel(){
    const veiculos = await apiGet("/veiculos");
    const opt = v => `<option value="${v.id_veiculo}">${v.placa} — ${v.marca} ${v.modelo}</option>`;
    document.getElementById('sel-pd-veiculo').innerHTML = veiculos.map(opt).join('');
    document.getElementById('sel-hist-veiculo').innerHTML = veiculos.map(opt).join('');
  }

  async function consultaPecas(id_veiculo){
    const data = await apiGet(`/relatorios/pecas-danificadas?veiculo_id=${id_veiculo}`);
    showSection('relatorios');
    const sel = document.getElementById('sel-pd-veiculo');
    sel.value = id_veiculo;

    const lista = data.pecas_para_troca || [];
    const veiculo = data.veiculo || {};
    const cliente = data.cliente || {};

    let tot = 0, importadas = 0, nacionais = 0;
    for (const p of lista){
      const qtd = Number(p.qtd_total || 0);
      tot += qtd;
      if (p.origem === 'importada') importadas += qtd;
      else nacionais += qtd;
    }
    let nivel = 'Baixa';
    if (importadas >= nacionais && importadas > 0) nivel = 'Alta';
    else if (importadas > 0) nivel = 'Média';

    const veicLabel = `${veiculo.placa || ''} — ${veiculo.marca || ''} ${veiculo.modelo || ''}`;
    const clienteLabel = cliente.nome_razao || 'Cliente não informado';
    const clienteDoc = cliente.cpf_cnpj || '';

    const rows = lista.map(r =>
      `<tr>
        <td>${r.id_peca}</td>
        <td>${r.descricao}</td>
        <td>${r.origem}</td>
        <td>${r.qtd_total}</td>
      </tr>`
    ).join('');

    const tabela = table(["ID","Peça","Origem","Qtd total"], rows || '<tr><td colspan="4">Sem peças registradas.</td></tr>');

    document.getElementById('rel31-table').innerHTML = `
      <div class="doc-card">
        <div class="doc-header">
          <div>
            <div class="doc-title">Relatório de Peças Necessárias para Troca</div>
            <div class="doc-subtitle">${veicLabel}</div>
            <div class="doc-mini">${clienteLabel} — ${clienteDoc}</div>
          </div>
          <div class="doc-meta">
            <div>Peças totais: <strong>${tot}</strong></div>
            <div>Nacionais: ${nacionais} &nbsp;•&nbsp; Importadas: ${importadas}</div>
            <div class="doc-badge"><span class="dot"></span>Complexidade: <strong>${nivel}</strong></div>
          </div>
        </div>

        <div class="doc-section-title">Lista de componentes <span>detalhamento por origem</span></div>
        <div class="doc-table-wrapper">
          ${tabela}
        </div>

        <div class="doc-footer-note">
          Este documento resume as peças danificadas identificadas nas últimas ordens de serviço
          para o veículo selecionado, indicando a proporção de itens importados que tendem a
          aumentar o custo e o prazo de reparo.
        </div>
      </div>
    `;
  }


  document.getElementById('btn-rel-31').addEventListener('click', ()=> {
    const id = document.getElementById('sel-pd-veiculo').value;
    if (id) {
      consultaPecas(id);
      // Mostra botão PDF do relatório 3.1 após gerar
      setTimeout(() => {
        document.getElementById('btn-pdf-31').classList.remove('d-none');
      }, 500);
    }
  });
  // document.getElementById('btn-rel-33').addEventListener('click', ()=> {
  //     const id = document.getElementById('sel-hist-veiculo').value;
  //     if (id) consultaHistoricoCompleto(id);
  // });

// ---------- Novo Agendamento ----------

  // Carrega CLIENTES e SERVIÇOS; veículos são carregados depois, por cliente
    async function preloadAgendamentoCombos(){
      const [clientes, servicos] = await Promise.all([
        apiGet("/clientes"),
        apiGet("/servicos"),
      ]);

      const selCliente = document.getElementById("agCliente");
      const selVeiculo = document.getElementById("agVeiculo");
      const selServico = document.getElementById("agServico");

      // clientes
      selCliente.innerHTML = `
        <option value="">Selecione um cliente</option>
        ${clientes.map(c => `
          <option value="${c.id_cliente}">${c.nome_razao}</option>
        `).join("")}
      `;

      // serviços
      selServico.innerHTML = `
        <option value="">Selecione um serviço</option>
        ${servicos.map(s => `
          <option value="${s.id_servico}">${s.descricao}</option>
        `).join("")}
      `;

      // veículos começam desabilitados
      selVeiculo.innerHTML = `<option value="">Selecione um cliente primeiro</option>`;
      selVeiculo.disabled = true;

      // sempre sobrescreve o handler
      selCliente.onchange = handleClienteChange;
    }

    // Quando o cliente muda, busca só os veículos dele
    async function handleClienteChange(){
      const selCliente = document.getElementById("agCliente");
      const selVeiculo = document.getElementById("agVeiculo");
      const idCliente  = selCliente.value;

      if (!idCliente){
        selVeiculo.innerHTML = `<option value="">Selecione um cliente primeiro</option>`;
        selVeiculo.disabled = true;
        return;
      }

      try{
        const veiculos = await apiGet(`/clientes/${idCliente}/veiculos`);

        if (!veiculos.length){
          selVeiculo.innerHTML = `<option value="">Este cliente não possui veículos cadastrados</option>`;
          selVeiculo.disabled = true;
          return;
        }

        selVeiculo.innerHTML = `
          <option value="">Selecione um veículo</option>
          ${veiculos.map(v => `
            <option value="${v.id}">
              ${v.placa} — ${v.marca} ${v.modelo}
            </option>
          `).join("")}
        `;
        selVeiculo.disabled = false;
      }catch(err){
        console.error(err);
        selVeiculo.innerHTML = `<option value="">Erro ao carregar veículos</option>`;
        selVeiculo.disabled = true;
      }
    }

    // Botão "Recarregar dados"
    document.getElementById("btn-recarregar-combos").addEventListener("click", ()=>{
      preloadAgendamentoCombos();
      preloadCombosRel();
      preloadVeiculoClientes();
    });

    // Salvar agendamento
    document.getElementById("btnSalvarAg").addEventListener("click", async ()=>{
      const idCliente = document.getElementById("agCliente").value;
      const idVeiculo = document.getElementById("agVeiculo").value;
      const idServico = document.getElementById("agServico").value;
      const dataHora  = document.getElementById("agDataHora").value;

      if (!idCliente || !idVeiculo || !idServico || !dataHora){
        alert("Selecione cliente, veículo, serviço e preencha a data/hora.");
        return;
      }

      const payload = {
        id_cliente: parseInt(idCliente),
        id_veiculo: parseInt(idVeiculo),
        id_servico: parseInt(idServico),
        data_hora: dataHora
      };

      try{
        await apiPost("/agendamentos", payload);
        bootstrap.Modal.getInstance(document.getElementById("modalAgendar")).hide();
        await carregarAgendamentos();
        showSection("agendamentos");
      }catch(e){
        alert(e?.data?.erro || e.message);
      }
    });

    // Sempre que o modal abrir, começa tudo em branco
    const modalAgendarEl = document.getElementById("modalAgendar");
    modalAgendarEl.addEventListener("show.bs.modal", () => {
      document.getElementById("agCliente").value = "";
      const selVeiculo = document.getElementById("agVeiculo");
      selVeiculo.innerHTML = `<option value="">Selecione um cliente primeiro</option>`;
      selVeiculo.disabled = true;
      document.getElementById("agServico").value = "";
      document.getElementById("agDataHora").value = "";
      preloadAgendamentoCombos();
    });

  // sempre que o modal abrir, zera os campos e recarrega combos
  // const modalAgendarEl = document.getElementById('modalAgendar');
  modalAgendarEl.addEventListener('show.bs.modal', () => {
    document.getElementById('agCliente').value = '';
    document.getElementById('agVeiculo').innerHTML = `<option value="">Selecione um cliente primeiro</option>`;
    document.getElementById('agVeiculo').disabled = true;
    document.getElementById('agServico').value = '';
    document.getElementById('agDataHora').value = '';
    preloadAgendamentoCombos();
  });


  // ---------- SUBMITS DE CADASTRO ----------
  document.getElementById('form-cliente').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      nome_razao: document.getElementById('cliNome').value,
      cpf_cnpj: document.getElementById('cliCpf').value
    };
    try{
      await apiPost('/clientes', payload);
      e.target.reset();
      await carregarClientes();
      await preloadVeiculoClientes();
      await preloadAgendamentoCombos();
    }catch(err){
      alert(err?.data?.erro || err.message);
    }
  });

  document.getElementById('form-funcionario').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      nome: document.getElementById('funNome').value,
      funcao: document.getElementById('funFuncao').value
    };
    try{
      await apiPost('/funcionarios', payload);
      e.target.reset();
      await carregarFuncionarios();
    }catch(err){
      alert(err?.data?.erro || err.message);
    }
  });

  document.getElementById('form-servico').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      descricao: document.getElementById('serDesc').value,
      preco_padrao: document.getElementById('serPreco').value || null
    };
    try{
      await apiPost('/servicos', payload);
      e.target.reset();
      await carregarServicos();
      await preloadAgendamentoCombos();
    }catch(err){
      alert(err?.data?.erro || err.message);
    }
  });

  document.getElementById('form-peca').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      sku: document.getElementById('pecSku').value,
      descricao: document.getElementById('pecDesc').value,
      origem: document.getElementById('pecOrigem').value,
      estoque_atual: parseInt(document.getElementById('pecEstoque').value || '0')
    };
    try{
      await apiPost('/pecas', payload);
      e.target.reset();
      await carregarPecas();
    }catch(err){
      alert(err?.data?.erro || err.message);
    }
  });

  document.getElementById('form-veiculo').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      placa: document.getElementById('veiPlaca').value,
      marca: document.getElementById('veiMarca').value,
      modelo: document.getElementById('veiModelo').value,
      km_atual: document.getElementById('veiKm').value ? parseInt(document.getElementById('veiKm').value) : null,
      id_cliente: parseInt(document.getElementById('veiCliente').value)
    };
    try{
      await apiPost('/veiculos', payload);
      e.target.reset();
      await carregarVeiculos();
      await preloadAgendamentoCombos();
    }catch(err){
      alert(err?.data?.erro || err.message);
    }
  });

  document.getElementById('form-fornecedor').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      nome_razao: document.getElementById('fornNome').value,
      cpf_cnpj: document.getElementById('fornCpf').value || null
    };
    try{
      await apiPost('/fornecedores', payload);
      e.target.reset();
      await carregarFornecedores();
    }catch(err){
      alert(err?.data?.erro || err.message);
    }
  });

  // ========== RELATÓRIO 3.3 - Histórico Completo ==========
  async function consultaHistoricoCompleto(veiculo_id){
    const data = await apiGet(`/relatorios/historico-veiculo-completo?veiculo_id=${veiculo_id}`);
    const bloco = document.getElementById("rel33-blocos");
    bloco.innerHTML = "";

    if (!data.ordens || data.ordens.length === 0){
      bloco.innerHTML = `<div class="os-doc-empty">Não há ordens de serviço para este veículo.</div>`;
      return;
    }

    const veic = data.veiculo;
    const cli = data.cliente;

    data.ordens.forEach(os => {
      const servicosRows = (os.servicos || []).map(s => `
        <tr>
          <td>${s.descricao}</td>
          <td>${s.qtd}</td>
          <td>R$ ${parseFloat(s.valor_unit || 0).toFixed(2)}</td>
        </tr>
      `).join("") || `<tr><td colspan="3" class="os-doc-empty">Nenhum serviço</td></tr>`;

      const pecasRows = (os.pecas || []).map(p => `
        <tr>
          <td>${p.descricao}</td>
          <td>${p.origem}</td>
          <td>${p.qtd}</td>
          <td>R$ ${parseFloat(p.valor_unit || 0).toFixed(2)}</td>
        </tr>
      `).join("") || `<tr><td colspan="4" class="os-doc-empty">Nenhuma peça</td></tr>`;

      const pagamentosRows = (os.pagamentos || []).map(pg => `
        <tr>
          <td>${pg.data ? pg.data.slice(0,10) : "-"}</td>
          <td>${pg.forma || "-"}</td>
          <td>R$ ${parseFloat(pg.valor || 0).toFixed(2)}</td>
        </tr>
      `).join("") || `<tr><td colspan="3" class="os-doc-empty">Nenhum pagamento</td></tr>`;

      const totalServicos = (os.servicos || []).reduce((acc, s) => acc + (parseFloat(s.qtd || 0) * parseFloat(s.valor_unit || 0)), 0);
      const totalPecas = (os.pecas || []).reduce((acc, p) => acc + (parseFloat(p.qtd || 0) * parseFloat(p.valor_unit || 0)), 0);
      const totalOS = totalServicos + totalPecas;

      const statusLabel = (os.status || "").replace(/_/g, " ").toUpperCase();

      bloco.innerHTML += `
        <div class="os-doc">
          <div class="os-doc-header">
            <div>
              <div class="os-doc-title">Ordem de Serviço #${os.id_os}</div>
              <div class="os-doc-subtitle">${veic.placa} — ${veic.marca} ${veic.modelo}</div>
              <div class="os-doc-mini">${cli.nome} — ${cli.cpf_cnpj}</div>
            </div>
            <div class="os-doc-meta">
              <div class="os-doc-status">${statusLabel}</div>
              <div class="os-doc-total">Valor total: R$ ${totalOS.toFixed(2)}</div>
            </div>
          </div>
          <table class="os-doc-table">
            <tr class="os-doc-section-row"><th colspan="3">Serviços Aplicados</th></tr>
            <tr><th>Descrição</th><th>Qtd</th><th>Valor</th></tr>
            ${servicosRows}
            <tr class="os-doc-section-row"><th colspan="4">Peças Trocadas</th></tr>
            <tr><th>Peça</th><th>Origem</th><th>Qtd</th><th>Valor</th></tr>
            ${pecasRows}
            <tr class="os-doc-section-row"><th colspan="3">Pagamentos</th></tr>
            <tr><th>Data</th><th>Forma</th><th>Valor</th></tr>
            ${pagamentosRows}
          </table>
          <div class="os-doc-footer">
            <div><strong>Técnico:</strong> ${os.responsavel || "-"}</div>
            <div><strong>KM entrada:</strong> ${os.km_entrada ?? "-"}</div>
            <div><strong>Problema relatado:</strong> ${os.problema_relatado || "-"}</div>
          </div>
        </div>
      `;
    });
  }

  // Botão "Emitir relatório" (3.3)
  document.getElementById("btn-rel-33").onclick = () => {
    const sel = document.getElementById("sel-hist-veiculo");
    const id = Number(sel.value);
    if (!id) {
      alert("Selecione um veículo primeiro.");
      return;
    }
    consultaHistoricoCompleto(id);
    // Mostra botão PDF do relatório 3.3 após gerar
    setTimeout(() => {
      document.getElementById('btn-pdf-33').classList.remove('d-none');
    }, 500);
  };

  // Botão PDF individual do relatório 3.1
  document.getElementById('btn-pdf-31').addEventListener('click', () => {
    const rel31 = document.getElementById('rel31-table');
    if (!rel31 || !rel31.innerHTML.trim()) {
      alert('Gere o relatório 3.1 primeiro!');
      return;
    }
    // Marca qual relatório está sendo impresso
    document.body.setAttribute('data-print-report', '31');
    setTimeout(() => {
      window.print();
      document.body.removeAttribute('data-print-report');
    }, 100);
  });

  // Botão PDF individual do relatório 3.3
  document.getElementById('btn-pdf-33').addEventListener('click', () => {
    const rel33 = document.getElementById('rel33-blocos');
    if (!rel33 || !rel33.innerHTML.trim()) {
      alert('Gere o relatório 3.3 primeiro!');
      return;
    }
    // Marca qual relatório está sendo impresso
    document.body.setAttribute('data-print-report', '33');
    setTimeout(() => {
      window.print();
      document.body.removeAttribute('data-print-report');
    }, 100);
  });

  // Botão "Exportar PDF"
  document.getElementById('btn-imprimir-relatorios').addEventListener('click', () => {
    const relContainer = document.getElementById('rel33-blocos');
    
    if (!relContainer || !relContainer.innerHTML.trim()) {
      alert('Gere um relatório primeiro antes de exportar!');
      return;
    }

    setTimeout(() => {
      window.print();
    }, 100);
  });

  // boot
  preloadAgendamentoCombos();
  preloadVeiculoClientes();
  showSection('home');
</script>

</body>
</html>
